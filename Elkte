-- StarterPlayerScripts > EliteBodyguardSystem (LocalScript)
local P=game.Players.LocalPlayer
local RS=game:GetService("RunService")
local UIS=game:GetService("UserInputService")
local TW=game:GetService("TweenService")
local DEB=game:GetService("Debris")
local TS=game:GetService("TextChatService")

local guards,spies={},{}
local active,guardCount,formation,aggroMode=false,5,"Circle","Defensive"
local totalFlings,commandTarget=0,nil
local forceShield,forceCharge,forceHold=false,false,false
local rescued,rescueCooldown=false,0
local autoRescue=true -- toggle for rescue system

-- Track if WE caused the fling (so we don't rescue from our own guards)
local playerFlung=false
local playerFlungTime=0

local QUOTES={
	idle={"Area secure.","All clear.","Standing by.","Perimeter holding.","Eyes open.","No threats detected.","Position held.","Scanning."},
	threat={"THREAT DETECTED!","ENGAGING!","PROTECT VIP!","TAKE THEM DOWN!","CONTACT!","HOSTILE!","WEAPONS HOT!","MOVE!"},
	fling={"LAUNCHED!","SENT FLYING!","HOME RUN!","YEETED!","AIRBORNE!","OUTTA HERE!","BYE BYE!","SEE YA!"},
	rescue={"GOTCHA!","You're safe!","Close call!","Not on my watch!","I got you!","Hang on!"},
	spy={"Intel on %s.","Tracking %s...","Monitoring %s.","Eyes on %s."},
	patrol={"Moving to waypoint.","Checking perimeter.","Sweeping area.","All quiet.","Nothing unusual."},
	taunt={"Is that all you got?","Come at me!","Try harder!","You call that an attack?","Pathetic!","Weak!"}
}

-- ============================================
-- FLING ENGINE
-- ============================================
local function directFling(targetChr,dir,power)
	local tHRP=targetChr:FindFirstChild("HumanoidRootPart")
	if not tHRP then return end
	local tHum=targetChr:FindFirstChildWhichIsA("Humanoid")

	-- Mark that we're flinging so rescue doesn't trigger
	playerFlung=true
	playerFlungTime=tick()

	for _,c in ipairs(tHRP:GetChildren()) do
		if c:IsA("BodyVelocity") or c:IsA("BodyAngularVelocity") or c:IsA("BodyGyro") then c:Destroy() end
	end

	if tHum then
		tHum.Sit=false
		tHum.PlatformStand=true
		task.delay(3,function() if tHum.Parent then tHum.PlatformStand=false end end)
	end

	for _,p in ipairs(targetChr:GetDescendants()) do
		if p:IsA("BasePart") then p.Anchored=false end
	end

	local bv=Instance.new("BodyVelocity",tHRP)
	bv.MaxForce=Vector3.new(math.huge,math.huge,math.huge)
	bv.Velocity=dir*power+Vector3.new(0,power*.8,0)
	bv.P=math.huge
	DEB:AddItem(bv,.4)

	task.delay(.15,function()
		if tHRP.Parent then
			local bv2=Instance.new("BodyVelocity",tHRP)
			bv2.MaxForce=Vector3.new(math.huge,math.huge,math.huge)
			bv2.Velocity=dir*power*.7+Vector3.new(0,power*.5,0)
			bv2.P=math.huge
			DEB:AddItem(bv2,.3)
		end
	end)

	local av=Instance.new("BodyAngularVelocity",tHRP)
	av.AngularVelocity=Vector3.new(math.random(-50,50),math.random(-50,50),math.random(-50,50))
	av.MaxTorque=Vector3.new(math.huge,math.huge,math.huge)
	av.P=math.huge
	DEB:AddItem(av,.7)

	-- VFX
	local fx=Instance.new("Part",workspace)
	fx.Shape=Enum.PartType.Ball fx.Size=Vector3.new(2,2,2)
	fx.CFrame=CFrame.new(tHRP.Position) fx.Anchored=true fx.CanCollide=false
	fx.Color=Color3.fromRGB(255,180,50) fx.Material=Enum.Material.Neon fx.Transparency=.2
	TW:Create(fx,TweenInfo.new(.4),{Size=Vector3.new(8,8,8),Transparency=1}):Play()
	DEB:AddItem(fx,.5)

	totalFlings+=1
end

local function spawnOrbitFlingers(gd,targetChr,power)
	local tHRP=targetChr:FindFirstChild("HumanoidRootPart")
	if not tHRP then return end
	local myChar=P.Character
	if not myChar then return end
	local myHRP=myChar:FindFirstChild("HumanoidRootPart")
	if not myHRP then return end

	for i=1,math.random(2,4) do
		task.spawn(function()
			local brick=Instance.new("Part",myChar)
			brick.Name="OBrick" brick.Size=Vector3.new(2.5,2.5,2.5)
			brick.Transparency=.85 brick.CanCollide=true brick.Massless=true brick.Anchored=false
			brick.CustomPhysicalProperties=PhysicalProperties.new(50,2,0,100,0)

			local weld=Instance.new("Weld",brick)
			weld.Part0=myHRP weld.Part1=brick

			local oR=math.random(2,4)
			local oS=math.random(12,22)
			local sA=math.random()*math.pi*2
			local sT=tick()
			local dur=2+math.random()*.5
			local hit=false

			brick.Touched:Connect(function(hitPart)
				if hit then return end
				local hc=hitPart.Parent
				if not hc then return end
				-- DON'T fling ourselves or our guards
				if hc==myChar then return end
				for _,g in ipairs(guards) do if hc==g.model then return end end

				if hc:FindFirstChildWhichIsA("Humanoid") then
					local hp=game.Players:GetPlayerFromCharacter(hc)
					if hp and hp~=P then
						hit=true
						local d=(hitPart.Position-brick.Position)
						if d.Magnitude>.01 then d=d.Unit else d=Vector3.new(0,1,0) end
						directFling(hc,d,power)
						brick:Destroy()
					end
				end
			end)

			while tick()-sT<dur and brick.Parent and tHRP.Parent do
				local elapsed=tick()-sT
				local angle=sA+elapsed*oS
				local targetPos=tHRP.Position+Vector3.new(math.cos(angle)*oR,math.sin(elapsed*6)*1.5,math.sin(angle)*oR)
				local offset=targetPos-myHRP.Position
				weld.C0=CFrame.new(offset)*CFrame.Angles(elapsed*10,elapsed*8,elapsed*6)
				RS.Heartbeat:Wait()
			end
			if brick.Parent then brick:Destroy() end
		end)
	end
end

local function runFlingEngine(gd,targetChr)
	local tHRP=targetChr:FindFirstChild("HumanoidRootPart")
	if not tHRP then return end
	local myChar=P.Character
	if not myChar then return end
	local myHRP=myChar:FindFirstChild("HumanoidRootPart")
	if not myHRP then return end

	-- Mark fling active so rescue ignores
	playerFlung=true
	playerFlungTime=tick()

	if not gd.flingProxy or not gd.flingProxy.Parent then
		local proxy=Instance.new("Part")
		proxy.Name="FProxy" proxy.Size=Vector3.new(4,1,4)
		proxy.Transparency=1 proxy.CanCollide=false proxy.Massless=true proxy.Anchored=false
		proxy.Parent=myChar
		local w=Instance.new("Weld",proxy)
		w.Part0=myHRP w.Part1=proxy w.C0=CFrame.new(0,-100,0)
		gd.flingProxy=proxy gd.flingWeld=w
	end

	task.spawn(function()
		local proxy=gd.flingProxy
		local weld=gd.flingWeld
		if not proxy or not proxy.Parent or not weld or not weld.Parent then return end

		local offset=tHRP.Position-myHRP.Position
		weld.C0=CFrame.new(offset)

		local origVel=myHRP.Velocity
		local movel=0.1

		for i=1,6 do
			if not tHRP.Parent or not myHRP.Parent then break end
			weld.C0=CFrame.new(tHRP.Position-myHRP.Position)
			myHRP.Velocity=origVel*10000+Vector3.new(0,10000,0)
			RS.RenderStepped:Wait()
			myHRP.Velocity=origVel
			RS.Stepped:Wait()
			myHRP.Velocity=origVel+Vector3.new(0,movel,0)
			movel=-movel
		end

		weld.C0=CFrame.new(0,-100,0)
		playerFlung=true
		playerFlungTime=tick()
	end)
end

local function masterFling(gd,targetChr,dir,power)
	-- Check target isn't us or our guards
	local tPlr=game.Players:GetPlayerFromCharacter(targetChr)
	if tPlr==P then return end
	for _,g in ipairs(guards) do if targetChr==g.model then return end end

	playerFlung=true
	playerFlungTime=tick()

	pcall(function() runFlingEngine(gd,targetChr) end)
	pcall(function() directFling(targetChr,dir,power) end)
	pcall(function() spawnOrbitFlingers(gd,targetChr,power) end)
end

-- ============================================
-- GUI
-- ============================================
local sg=Instance.new("ScreenGui",P.PlayerGui)
sg.Name="BG_GUI" sg.ResetOnSpawn=false sg.DisplayOrder=100

local main=Instance.new("Frame",sg)
main.Size=UDim2.new(0,230,0.6,0) main.Position=UDim2.new(0,10,0.2,0)
main.BackgroundColor3=Color3.fromRGB(10,10,20) main.BorderSizePixel=0
Instance.new("UICorner",main).CornerRadius=UDim.new(0,10)
local ms=Instance.new("UIStroke",main) ms.Color=Color3.fromRGB(50,120,255) ms.Thickness=1.5

local title=Instance.new("TextLabel",main)
title.Size=UDim2.new(1,0,0,26) title.BackgroundColor3=Color3.fromRGB(15,25,50) title.BorderSizePixel=0
title.Text="üõ°Ô∏è BODYGUARD SYS" title.TextColor3=Color3.fromRGB(180,210,255)
title.Font=Enum.Font.GothamBlack title.TextSize=12
Instance.new("UICorner",title).CornerRadius=UDim.new(0,10)

local scroll=Instance.new("ScrollingFrame",main)
scroll.Size=UDim2.new(1,-6,1,-30) scroll.Position=UDim2.new(0,3,0,28)
scroll.BackgroundTransparency=1 scroll.ScrollBarThickness=3
scroll.ScrollBarImageColor3=Color3.fromRGB(50,120,255)
scroll.CanvasSize=UDim2.new(0,0,0,0) scroll.AutomaticCanvasSize=Enum.AutomaticSize.Y
scroll.BorderSizePixel=0
local sL=Instance.new("UIListLayout",scroll) sL.Padding=UDim.new(0,3) sL.SortOrder=Enum.SortOrder.LayoutOrder

local function lbl(t,o)
	local l=Instance.new("TextLabel",scroll)
	l.Size=UDim2.new(1,-6,0,15) l.BackgroundTransparency=1
	l.Text=t l.TextColor3=Color3.fromRGB(180,190,210)
	l.Font=Enum.Font.Gotham l.TextSize=10 l.TextXAlignment=Enum.TextXAlignment.Left
	l.LayoutOrder=o l.TextWrapped=true
	return l
end
local function btn(t,c,o,fn)
	local b=Instance.new("TextButton",scroll)
	b.Size=UDim2.new(1,-6,0,24) b.BackgroundColor3=c
	b.TextColor3=Color3.new(1,1,1) b.Text=t
	b.Font=Enum.Font.GothamBold b.TextSize=10 b.LayoutOrder=o
	Instance.new("UICorner",b).CornerRadius=UDim.new(0,5)
	b.MouseButton1Click:Connect(fn) return b
end
local function sep(o)
	local s=Instance.new("Frame",scroll) s.Size=UDim2.new(1,-14,0,1)
	s.BackgroundColor3=Color3.fromRGB(35,35,55) s.BorderSizePixel=0 s.LayoutOrder=o
end

-- Status
local stL=lbl("‚ö° Inactive",1)
local thL=lbl("‚ö†Ô∏è Threats: 0",2)
local gL=lbl("üë• Guards: 0/0",3)
local spL=lbl("üïµÔ∏è Spies: 0",4)
local flL=lbl("üíÄ Flings: 0",5)
local wpL=lbl("üìç Waypoints: 0",6)
sep(7)

-- Slider
local sF=Instance.new("Frame",scroll) sF.Size=UDim2.new(1,-6,0,30) sF.BackgroundTransparency=1 sF.LayoutOrder=8
local sLabel=Instance.new("TextLabel",sF)
sLabel.Size=UDim2.new(1,0,0,12) sLabel.BackgroundTransparency=1
sLabel.Text="Guards: 5" sLabel.TextColor3=Color3.fromRGB(180,190,210)
sLabel.Font=Enum.Font.Gotham sLabel.TextSize=10 sLabel.TextXAlignment=Enum.TextXAlignment.Left
local trk=Instance.new("Frame",sF) trk.Size=UDim2.new(1,0,0,4) trk.Position=UDim2.new(0,0,0,18)
trk.BackgroundColor3=Color3.fromRGB(30,30,45) trk.BorderSizePixel=0
Instance.new("UICorner",trk).CornerRadius=UDim.new(1,0)
local fl2=Instance.new("Frame",trk) fl2.Size=UDim2.new(5/15,0,1,0) fl2.BackgroundColor3=Color3.fromRGB(50,120,255) fl2.BorderSizePixel=0
Instance.new("UICorner",fl2).CornerRadius=UDim.new(1,0)
local kb=Instance.new("TextButton",trk) kb.Size=UDim2.new(0,12,0,12) kb.Position=UDim2.new(5/15,-6,.5,-6)
kb.BackgroundColor3=Color3.fromRGB(100,170,255) kb.Text="" kb.BorderSizePixel=0 kb.ZIndex=5
Instance.new("UICorner",kb).CornerRadius=UDim.new(1,0)
local drg=false
kb.MouseButton1Down:Connect(function() drg=true end)
UIS.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then drg=false end end)
UIS.InputChanged:Connect(function(i)
	if drg and(i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch)then
		local r=math.clamp((i.Position.X-trk.AbsolutePosition.X)/trk.AbsoluteSize.X,0,1)
		guardCount=math.clamp(math.floor(1+r*14+.5),1,15)
		fl2.Size=UDim2.new(r,0,1,0) kb.Position=UDim2.new(r,-6,.5,-6)
		sLabel.Text="Guards: "..guardCount
	end
end)
sep(9)

-- Formation grid
lbl("üìê Formation:",10)
local fF=Instance.new("Frame",scroll) fF.Size=UDim2.new(1,-6,0,0) fF.AutomaticSize=Enum.AutomaticSize.Y
fF.BackgroundTransparency=1 fF.LayoutOrder=11
Instance.new("UIGridLayout",fF).CellSize=UDim2.new(.32,0,0,18)
fF:FindFirstChildOfClass("UIGridLayout").CellPadding=UDim2.new(.01,0,0,2)
local fms={"Circle","V-Shape","Line","Diamond","Wall","Surround"}
local fBs={}
for _,fm in ipairs(fms) do
	local fb=Instance.new("TextButton",fF)
	fb.BackgroundColor3=fm==formation and Color3.fromRGB(50,120,255) or Color3.fromRGB(25,25,40)
	fb.TextColor3=Color3.new(1,1,1) fb.Text=fm fb.Font=Enum.Font.Gotham fb.TextSize=8
	Instance.new("UICorner",fb).CornerRadius=UDim.new(0,4)
	fBs[fm]=fb
	fb.MouseButton1Click:Connect(function()
		formation=fm
		for k,v in pairs(fBs) do v.BackgroundColor3=k==fm and Color3.fromRGB(50,120,255) or Color3.fromRGB(25,25,40) end
	end)
end

-- Mode grid
lbl("‚öîÔ∏è Mode:",12)
local mF=Instance.new("Frame",scroll) mF.Size=UDim2.new(1,-6,0,0) mF.AutomaticSize=Enum.AutomaticSize.Y
mF.BackgroundTransparency=1 mF.LayoutOrder=13
Instance.new("UIGridLayout",mF).CellSize=UDim2.new(.48,0,0,18)
mF:FindFirstChildOfClass("UIGridLayout").CellPadding=UDim2.new(.01,0,0,2)
local mds={"Passive","Defensive","Aggressive","Berserker"}
local mCs={Passive=Color3.fromRGB(70,70,90),Defensive=Color3.fromRGB(30,70,160),Aggressive=Color3.fromRGB(180,70,25),Berserker=Color3.fromRGB(180,25,25)}
local mBs={}
for _,md in ipairs(mds) do
	local mb=Instance.new("TextButton",mF)
	mb.BackgroundColor3=md==aggroMode and mCs[md] or Color3.fromRGB(25,25,40)
	mb.TextColor3=Color3.new(1,1,1) mb.Text=md mb.Font=Enum.Font.Gotham mb.TextSize=9
	Instance.new("UICorner",mb).CornerRadius=UDim.new(0,4)
	mBs[md]=mb
	mb.MouseButton1Click:Connect(function()
		aggroMode=md
		for k,v in pairs(mBs) do v.BackgroundColor3=k==md and mCs[md] or Color3.fromRGB(25,25,40) end
	end)
end
sep(14)

-- Notifs
local nH=Instance.new("Frame",sg) nH.Size=UDim2.new(0,190,0.35,0) nH.Position=UDim2.new(1,-198,0,6)
nH.BackgroundTransparency=1
Instance.new("UIListLayout",nH).Padding=UDim.new(0,3)
local function notify(t,c)
	local nf=Instance.new("Frame",nH) nf.Size=UDim2.new(1,0,0,22)
	nf.BackgroundColor3=c or Color3.fromRGB(20,40,80) nf.BackgroundTransparency=.15 nf.BorderSizePixel=0
	Instance.new("UICorner",nf).CornerRadius=UDim.new(0,5)
	local nl=Instance.new("TextLabel",nf) nl.Size=UDim2.new(1,-6,1,0) nl.Position=UDim2.new(0,3,0,0)
	nl.BackgroundTransparency=1 nl.Text=t nl.TextColor3=Color3.new(1,1,1)
	nl.Font=Enum.Font.GothamBold nl.TextSize=9 nl.TextXAlignment=Enum.TextXAlignment.Left nl.TextWrapped=true
	task.delay(3,function()
		TW:Create(nf,TweenInfo.new(.3),{BackgroundTransparency=1}):Play()
		TW:Create(nl,TweenInfo.new(.3),{TextTransparency=1}):Play()
		DEB:AddItem(nf,.4)
	end)
end

-- ============================================
-- WAYPOINT SYSTEM
-- ============================================
local waypoints={}
local patrolMode=false

local function createWaypointMarker(pos,idx)
	local part=Instance.new("Part",workspace)
	part.Name="Waypoint_"..idx
	part.Shape=Enum.PartType.Cylinder
	part.Size=Vector3.new(.3,3,3)
	part.CFrame=CFrame.new(pos)*CFrame.Angles(0,0,math.rad(90))
	part.Color=Color3.fromRGB(50,200,100)
	part.Material=Enum.Material.Neon
	part.Anchored=true part.CanCollide=false part.Transparency=.4

	local bb=Instance.new("BillboardGui",part)
	bb.Size=UDim2.new(0,40,0,18) bb.StudsOffset=Vector3.new(0,2.5,0) bb.AlwaysOnTop=true
	local tl=Instance.new("TextLabel",bb) tl.Size=UDim2.new(1,0,1,0) tl.BackgroundColor3=Color3.fromRGB(10,10,20)
	tl.BackgroundTransparency=.2 tl.TextColor3=Color3.fromRGB(50,200,100) tl.Font=Enum.Font.GothamBold
	tl.TextSize=10 tl.Text="üìç "..idx tl.BorderSizePixel=0
	Instance.new("UICorner",tl).CornerRadius=UDim.new(0,4)

	return part
end

-- ============================================
-- GUARD CREATION
-- ============================================
local function makeGun(parent)
	local body=Instance.new("Part",parent) body.Name="GunBody" body.Size=Vector3.new(.2,.25,1.2)
	body.Color=Color3.fromRGB(25,25,25) body.Material=Enum.Material.Metal body.CanCollide=false
	local barrel=Instance.new("Part",parent) barrel.Size=Vector3.new(.1,.1,.6)
	barrel.Color=Color3.fromRGB(40,40,40) barrel.Material=Enum.Material.Metal barrel.CanCollide=false
	local bw=Instance.new("Weld",body) bw.Part0=body bw.Part1=barrel bw.C0=CFrame.new(0,.03,-.85)
	local grip=Instance.new("Part",parent) grip.Size=Vector3.new(.12,.4,.18)
	grip.Color=Color3.fromRGB(40,28,12) grip.Material=Enum.Material.Wood grip.CanCollide=false
	local gw=Instance.new("Weld",body) gw.Part0=body gw.Part1=grip gw.C0=CFrame.new(0,-.28,.2)
	local muzzle=Instance.new("Part",parent) muzzle.Size=Vector3.new(.06,.06,.06)
	muzzle.Transparency=1 muzzle.CanCollide=false
	local mw=Instance.new("Weld",barrel) mw.Part0=barrel mw.Part1=muzzle mw.C0=CFrame.new(0,0,-.35)
	return body,muzzle
end

local function createGuard(idx,total)
	local chr=P.Character if not chr then return nil end
	local hrp=chr:FindFirstChild("HumanoidRootPart") if not hrp then return nil end
	local g=Instance.new("Model") g.Name="Guard_"..idx
	local skin=Color3.fromRGB(170+math.random(-25,15),135+math.random(-15,10),95+math.random(-15,10))
	local function mp(n,sz,c)
		local p=Instance.new("Part",g) p.Name=n p.Size=sz p.Color=c or Color3.fromRGB(15,15,15)
		p.Material=Enum.Material.SmoothPlastic p.CanCollide=n~="HumanoidRootPart" p.Anchored=false
		if n=="HumanoidRootPart" then p.Transparency=1 end return p
	end
	local root=mp("HumanoidRootPart",Vector3.new(2,2,1))
	local torso=mp("Torso",Vector3.new(2,2,1))
	local head=mp("Head",Vector3.new(1,1,1),skin)
	local hm=Instance.new("SpecialMesh",head) hm.MeshType=Enum.MeshType.Head hm.Scale=Vector3.new(1.25,1.25,1.25)
	local face=Instance.new("Decal",head) face.Name="face" face.Texture="rbxasset://textures/face.png"
	local la=mp("Left Arm",Vector3.new(1,2,1),skin) local ra=mp("Right Arm",Vector3.new(1,2,1),skin)
	local ll=mp("Left Leg",Vector3.new(1,2,1)) local rl=mp("Right Leg",Vector3.new(1,2,1))

	local I=CFrame.new(0,0,0,-1,0,0,0,0,1,0,1,0)
	local function m6(n,p0,p1,c0,c1) local m=Instance.new("Motor6D",p0) m.Name=n m.Part0=p0 m.Part1=p1 m.C0=c0 m.C1=c1 or CFrame.new() return m end
	local rj=m6("RootJoint",root,torso,I,I)
	local nk=m6("Neck",torso,head,CFrame.new(0,1,0,-1,0,0,0,0,1,0,1,0),CFrame.new(0,-.5,0,-1,0,0,0,0,1,0,1,0))
	local ls=m6("Left Shoulder",torso,la,CFrame.new(-1,.5,0,0,0,-1,0,1,0,1,0,0),CFrame.new(.5,.5,0,0,0,-1,0,1,0,1,0,0))
	local rs=m6("Right Shoulder",torso,ra,CFrame.new(1,.5,0,0,0,1,0,1,0,-1,0,0),CFrame.new(-.5,.5,0,0,0,1,0,1,0,-1,0,0))
	local lh=m6("Left Hip",torso,ll,CFrame.new(-1,-1,0,0,0,-1,0,1,0,1,0,0),CFrame.new(-.5,1,0,0,0,-1,0,1,0,1,0,0))
	local rh=m6("Right Hip",torso,rl,CFrame.new(1,-1,0,0,0,1,0,1,0,-1,0,0),CFrame.new(.5,1,0,0,0,1,0,1,0,-1,0,0))

	local hum=Instance.new("Humanoid",g) hum.MaxHealth=1500 hum.Health=1500
	hum.WalkSpeed=22 hum.JumpPower=55 hum.DisplayName="Guard #"..idx
	g.PrimaryPart=root

	Instance.new("Shirt",g).ShirtTemplate="rbxassetid://769936308"
	Instance.new("Pants",g).PantsTemplate="rbxassetid://382537569"
	local bc=Instance.new("BodyColors",g) bc.HeadColor3=skin bc.TorsoColor3=Color3.fromRGB(15,15,15)
	bc.LeftArmColor3=skin bc.RightArmColor3=skin bc.LeftLegColor3=Color3.fromRGB(15,15,15) bc.RightLegColor3=Color3.fromRGB(15,15,15)

	local sh=Instance.new("Part",g) sh.Size=Vector3.new(.95,.28,.28) sh.Color=Color3.new(0,0,0)
	sh.CanCollide=false sh.Reflectance=.3
	local sw=Instance.new("Weld",head) sw.Part0=head sw.Part1=sh sw.C0=CFrame.new(0,.08,-.4)

	local ep=Instance.new("Part",g) ep.Size=Vector3.new(.12,.18,.12) ep.Color=Color3.fromRGB(20,20,20) ep.CanCollide=false
	local ew=Instance.new("Weld",head) ew.Part0=head ew.Part1=ep ew.C0=CFrame.new(.48,-.04,0)

	local gunBody,muzzle=makeGun(g)
	local gw2=Instance.new("Weld",ra) gw2.Part0=ra gw2.Part1=gunBody gw2.C0=CFrame.new(0,-1,-.25)*CFrame.Angles(math.rad(-90),0,0)

	-- Shield part (activates during shield mode)
	local shield=Instance.new("Part",g) shield.Name="Shield" shield.Size=Vector3.new(3,.3,3)
	shield.Color=Color3.fromRGB(40,100,200) shield.Material=Enum.Material.ForceField
	shield.Transparency=.6 shield.CanCollide=false shield.Anchored=false
	local shw=Instance.new("Weld",torso) shw.Part0=torso shw.Part1=shield shw.C0=CFrame.new(0,0,-1.5)
	shield.Transparency=1 -- hidden by default

	return {
		model=g,hum=hum,rootPart=root,torso=torso,head=head,
		rArm=ra,lArm=la,neck=nk,lShoulder=ls,rShoulder=rs,lHip=lh,rHip=rh,rootJoint=rj,
		muzzle=muzzle,shield=shield,index=idx,state="idle",target=nil,
		lastQuote=0,lastAttack=0,lastShot=0,flingProxy=nil,flingWeld=nil,
		patrolIdx=1,lastTaunt=0,combo=0
	}
end

-- ============================================
-- ANIMATIONS
-- ============================================
local function animGuard(gd)
	if not gd.model.Parent or gd.hum.Health<=0 then return end
	local spd=(gd.rootPart.Velocity*Vector3.new(1,0,1)).Magnitude
	local t=tick()
	local jumping=gd.hum:GetState()==Enum.HumanoidStateType.Freefall
	pcall(function()
		if jumping then
			gd.lHip.C0=CFrame.new(-1,-1,0,0,0,-1,0,1,0,1,0,0)*CFrame.Angles(math.rad(-20),0,0)
			gd.rHip.C0=CFrame.new(1,-1,0,0,0,1,0,1,0,-1,0,0)*CFrame.Angles(math.rad(20),0,0)
			gd.lShoulder.C0=CFrame.new(-1,.5,0,0,0,-1,0,1,0,1,0,0)*CFrame.Angles(math.rad(160),0,0)
			gd.rShoulder.C0=CFrame.new(1,.5,0,0,0,1,0,1,0,-1,0,0)*CFrame.Angles(math.rad(160),0,0)
		elseif spd>1 then
			local c=t*(spd>12 and 9 or 5.5) local s=math.sin(c)
			gd.lHip.C0=CFrame.new(-1,-1,0,0,0,-1,0,1,0,1,0,0)*CFrame.Angles(s*(spd>12 and 1.1 or .65),0,0)
			gd.rHip.C0=CFrame.new(1,-1,0,0,0,1,0,1,0,-1,0,0)*CFrame.Angles(-s*(spd>12 and 1.1 or .65),0,0)
			gd.lShoulder.C0=CFrame.new(-1,.5,0,0,0,-1,0,1,0,1,0,0)*CFrame.Angles(-s*(spd>12 and 1.3 or .75),0,0)
			if gd.state=="attacking" or gd.state=="shooting" then
				gd.rShoulder.C0=CFrame.new(1,.5,0,0,0,1,0,1,0,-1,0,0)*CFrame.Angles(math.rad(-90),0,0)
			else
				gd.rShoulder.C0=CFrame.new(1,.5,0,0,0,1,0,1,0,-1,0,0)*CFrame.Angles(s*.4,0,0)
			end
			gd.rootJoint.C0=CFrame.new(0,0,0,-1,0,0,0,0,1,0,1,0)*CFrame.new(0,math.abs(s)*.1,0)
		else
			local br=math.sin(t*1.5) local sy=math.sin(t*.8)
			gd.lHip.C0=gd.lHip.C0:Lerp(CFrame.new(-1,-1,0,0,0,-1,0,1,0,1,0,0),.08)
			gd.rHip.C0=gd.rHip.C0:Lerp(CFrame.new(1,-1,0,0,0,1,0,1,0,-1,0,0),.08)
			gd.lShoulder.C0=CFrame.new(-1,.5,0,0,0,-1,0,1,0,1,0,0)*CFrame.Angles(0,0,math.rad(-4+sy*2))
			if gd.state=="attacking" or gd.state=="shooting" then
				gd.rShoulder.C0=CFrame.new(1,.5,0,0,0,1,0,1,0,-1,0,0)*CFrame.Angles(math.rad(-90),0,0)
			else
				gd.rShoulder.C0=CFrame.new(1,.5,0,0,0,1,0,1,0,-1,0,0)*CFrame.Angles(math.rad(-25),0,math.rad(8))
			end
			gd.rootJoint.C0=CFrame.new(0,0,0,-1,0,0,0,0,1,0,1,0)*CFrame.new(0,br*.04,0)
			gd.neck.C0=CFrame.new(0,1,0,-1,0,0,0,0,1,0,1,0)*CFrame.Angles(sy*.02,sy*.03,0)
		end
		if gd.state=="punching" then
			local pp=(t-gd.lastAttack)/.35
			if pp<1 then gd.rShoulder.C0=CFrame.new(1,.5,0,0,0,1,0,1,0,-1,0,0)*CFrame.Angles(-math.sin(pp*math.pi)*math.rad(130),0,0)
			else gd.state=gd.target and "attacking" or "idle" end
		end
	end)
end

-- ============================================
-- DEPLOY
-- ============================================
local function deployGuard(idx,total)
	local chr=P.Character if not chr then return nil end
	local hrp=chr:FindFirstChild("HumanoidRootPart") if not hrp then return nil end
	local gd=createGuard(idx,total) if not gd then return nil end
	local angle=(idx/total)*math.pi*2
	local r=7+total*.4
	local ground=hrp.Position+Vector3.new(math.cos(angle)*r,0,math.sin(angle)*r)
	local dropH=65 local sky=ground+Vector3.new(0,dropH,0)
	gd.model:SetPrimaryPartCFrame(CFrame.new(sky)) gd.rootPart.Anchored=true gd.model.Parent=workspace

	local rope=Instance.new("Part",workspace) rope.Size=Vector3.new(.08,dropH,.08)
	rope.CFrame=CFrame.new(sky+Vector3.new(0,dropH/2,0)) rope.Color=Color3.fromRGB(100,80,40)
	rope.Material=Enum.Material.Fabric rope.Anchored=true rope.CanCollide=false

	local heli=Instance.new("Part",workspace) heli.Size=Vector3.new(4,1.2,8)
	heli.CFrame=CFrame.new(sky+Vector3.new(0,dropH+3,0)) heli.Color=Color3.fromRGB(25,25,30)
	heli.Material=Enum.Material.Metal heli.Anchored=true heli.CanCollide=false heli.Transparency=.2

	local rotor=Instance.new("Part",workspace) rotor.Size=Vector3.new(12,.1,.9)
	rotor.CFrame=heli.CFrame*CFrame.new(0,1,0) rotor.Color=Color3.fromRGB(50,50,50)
	rotor.Material=Enum.Material.Metal rotor.Anchored=true rotor.CanCollide=false rotor.Transparency=.3

	local hs=Instance.new("Sound",heli) hs.SoundId="rbxassetid://5982698631" hs.Volume=.3 hs.Looped=true hs:Play()

	task.spawn(function()
		task.spawn(function() local st=tick() while tick()-st<6 and rotor.Parent do
			rotor.CFrame=heli.CFrame*CFrame.new(0,1,0)*CFrame.Angles(0,(tick()*20)%(math.pi*2),0) task.wait() end end)
		local dt2=1.5+math.random()*.4 local st=tick()
		while tick()-st<dt2 do
			local p=(tick()-st)/dt2 local e=1-(1-p)^2.5
			local pos=sky:Lerp(ground+Vector3.new(0,3,0),e)
			gd.model:SetPrimaryPartCFrame(CFrame.new(pos))
			local rl=(sky.Y+dropH)-pos.Y rope.Size=Vector3.new(.08,math.max(.1,rl),.08)
			rope.CFrame=CFrame.new(pos+Vector3.new(0,rl/2,0)) task.wait()
		end
		gd.model:SetPrimaryPartCFrame(CFrame.new(ground+Vector3.new(0,3,0))) gd.rootPart.Anchored=false
		for i=1,5 do
			local d=Instance.new("Part",workspace) d.Shape=Enum.PartType.Ball d.Size=Vector3.new(.3,.3,.3)
			d.CFrame=CFrame.new(ground+Vector3.new(math.random(-3,3),.2,math.random(-3,3)))
			d.Color=Color3.fromRGB(150,140,120) d.Anchored=true d.CanCollide=false d.Transparency=.4
			TW:Create(d,TweenInfo.new(.8),{Transparency=1,Size=Vector3.new(2,2,2),Position=d.Position+Vector3.new(0,2,0)}):Play()
			DEB:AddItem(d,1)
		end
		task.delay(1.5,function() hs:Stop()
			TW:Create(heli,TweenInfo.new(2),{CFrame=heli.CFrame+Vector3.new(90,40,90),Transparency=1}):Play()
			TW:Create(rotor,TweenInfo.new(2),{Transparency=1}):Play()
			TW:Create(rope,TweenInfo.new(.6),{Transparency=1}):Play()
			DEB:AddItem(heli,2.5) DEB:AddItem(rotor,2.5) DEB:AddItem(rope,1)
		end)
	end)
	return gd
end

-- ============================================
-- SPEECH + SPY
-- ============================================
local function say(gd,cat)
	if tick()-gd.lastQuote<5 then return end gd.lastQuote=tick()
	local q=QUOTES[cat] if not q then return end
	local bb=Instance.new("BillboardGui",gd.head)
	bb.Size=UDim2.new(0,110,0,22) bb.StudsOffset=Vector3.new(0,2.6,0) bb.AlwaysOnTop=true
	local bg=Instance.new("Frame",bb) bg.Size=UDim2.new(1,0,1,0) bg.BackgroundColor3=Color3.fromRGB(10,10,20)
	bg.BackgroundTransparency=.15 bg.BorderSizePixel=0
	Instance.new("UICorner",bg).CornerRadius=UDim.new(0,5)
	local tl=Instance.new("TextLabel",bg) tl.Size=UDim2.new(1,-4,1,0) tl.Position=UDim2.new(0,2,0,0)
	tl.BackgroundTransparency=1 tl.Text=q[math.random(#q)] tl.TextColor3=Color3.new(1,1,1)
	tl.Font=Enum.Font.GothamBold tl.TextSize=8 tl.TextWrapped=true
	task.delay(2.5,function() if bb.Parent then TW:Create(bg,TweenInfo.new(.2),{BackgroundTransparency=1}):Play()
		TW:Create(tl,TweenInfo.new(.2),{TextTransparency=1}):Play() DEB:AddItem(bb,.3) end end)
end

local function createSpy(tPlr)
	local sd={target=tPlr,lastReport=0,markers={},active=true}
	task.spawn(function()
		while sd.active and task.wait(2) do
			local tc=tPlr.Character if tc then local th=tc:FindFirstChild("HumanoidRootPart") if th then
				local existing=nil for _,m in ipairs(sd.markers) do if m.Parent then existing=m break end end
				if not existing then
					local bb=Instance.new("BillboardGui") bb.Size=UDim2.new(0,65,0,20)
					bb.StudsOffset=Vector3.new(0,3.5,0) bb.AlwaysOnTop=true bb.Adornee=th
					pcall(function() bb.Parent=game:GetService("CoreGui") end)
					if not bb.Parent then bb.Parent=P.PlayerGui end
					local bg=Instance.new("Frame",bb) bg.Size=UDim2.new(1,0,1,0) bg.BackgroundColor3=Color3.fromRGB(200,40,40)
					bg.BackgroundTransparency=.2 bg.BorderSizePixel=0
					Instance.new("UICorner",bg).CornerRadius=UDim.new(0,4)
					local tl=Instance.new("TextLabel",bg) tl.Size=UDim2.new(1,0,1,0) tl.BackgroundTransparency=1
					tl.Text="üïµÔ∏è "..tPlr.Name tl.TextColor3=Color3.new(1,1,1)
					tl.Font=Enum.Font.GothamBold tl.TextSize=8 tl.TextWrapped=true
					table.insert(sd.markers,bb)
				end
				local mc=P.Character if mc then local mh=mc:FindFirstChild("HumanoidRootPart")
					if mh and tick()-sd.lastReport>12 then sd.lastReport=tick()
						local dist=math.floor((th.Position-mh.Position).Magnitude)
						notify("üïµÔ∏è "..tPlr.Name..": "..dist.."st",Color3.fromRGB(100,40,150))
						if dist<25 then notify("üö® "..tPlr.Name.." CLOSE!",Color3.fromRGB(255,50,30)) end
					end
				end
			end end
		end
		for _,m in ipairs(sd.markers) do if m.Parent then m:Destroy() end end
	end)
	return sd
end

-- ============================================
-- DETECTION
-- ============================================
local function hasDanger(tc)
	for _,c in ipairs(tc:GetDescendants()) do
		if c:IsA("Tool") then
			local n=c.Name:lower()
			for _,w in ipairs({"sword","knife","gun","pistol","rifle","bat","axe","blade","katana","blaster","weapon"}) do
				if n:find(w) then return true end
			end
			if c:FindFirstChild("Handle") then return true end
		end
	end return false
end

local function isChasing(plr,mc)
	local c=plr.Character if not c then return false end
	local h=c:FindFirstChild("HumanoidRootPart") if not h then return false end
	local mh=mc:FindFirstChild("HumanoidRootPart") if not mh then return false end
	local dist=(h.Position-mh.Position).Magnitude
	local d2=(mh.Position-h.Position) if d2.Magnitude<.01 then return false end
	local dot=d2.Unit:Dot(h.CFrame.LookVector)
	local hm=c:FindFirstChildWhichIsA("Humanoid") local mov=hm and hm.MoveDirection.Magnitude>.1
	if aggroMode=="Berserker" then return dist<65 end
	if aggroMode=="Aggressive" then return dist<50 and(hasDanger(c) or mov) end
	return dist<40 and dot>.3 and(hasDanger(c) or(dist<12 and mov))
end

local function getFormPos(i,tot,cf,td)
	local a=(i/tot)*math.pi*2 local r=5+tot*.3
	if formation=="Circle" then return cf.Position+Vector3.new(math.cos(a+tick()*.15)*r,0,math.sin(a+tick()*.15)*r)
	elseif formation=="V-Shape" then return cf.Position+cf.LookVector*(-math.ceil(i/2)*2.5)+cf.RightVector*((i%2==0 and 1 or-1)*math.ceil(i/2)*2)
	elseif formation=="Line" then return cf.Position+cf.RightVector*((i-(tot+1)/2)*2)+cf.LookVector*(-3)
	elseif formation=="Diamond" then local o={Vector3.new(0,0,1),Vector3.new(1,0,0),Vector3.new(0,0,-1),Vector3.new(-1,0,0)} return cf.Position+o[((i-1)%4)+1]*(math.ceil(i/4)*3)
	elseif formation=="Wall" then return cf.Position+((td and td.Unit) or cf.LookVector)*4+cf.RightVector*((i-(tot+1)/2)*1.6)
	elseif formation=="Surround" then return cf.Position+Vector3.new(math.cos(a)*2.5,0,math.sin(a)*2.5) end
	return cf.Position+Vector3.new(math.cos(a)*r,0,math.sin(a)*r)
end

-- ============================================
-- COMMANDS
-- ============================================
local function clearAll()
	for _,gd in ipairs(guards) do
		if gd.flingProxy and gd.flingProxy.Parent then gd.flingProxy:Destroy() end
		if gd.model and gd.model.Parent then gd.model:Destroy() end
	end
	for _,sd in ipairs(spies) do sd.active=false for _,m in ipairs(sd.markers) do if m.Parent then m:Destroy() end end end
	guards,spies={},{}
	active=false totalFlings=0
	gL.Text="üë• Guards: 0/0" stL.Text="‚ö° Inactive" spL.Text="üïµÔ∏è Spies: 0"
	notify("‚ùå Dismissed.",Color3.fromRGB(180,40,40))
end

local function spawnAll()
	clearAll()
	local n=guardCount
	notify("üöÅ Deploying "..n.."...",Color3.fromRGB(30,100,200))
	for i=1,n do task.delay((i-1)*.45,function()
		local gd=deployGuard(i,n) if gd then table.insert(guards,gd) end
		gL.Text="üë• Guards: "..#guards.."/"..n
	end) end
	active=true stL.Text="‚ö° Deploying..."
	task.delay(n*.45+2,function() if active then stL.Text="‚ö° Guarding" notify("‚úÖ Ready!",Color3.fromRGB(40,180,80)) end end)
end

local function shootAt(gd,targetChr)
	if tick()-gd.lastShot<.4 then return end gd.lastShot=tick() gd.state="shooting"
	local tHRP=targetChr:FindFirstChild("HumanoidRootPart") if not tHRP then return end
	if gd.muzzle and gd.muzzle.Parent then
		local flash=Instance.new("Part",workspace) flash.Shape=Enum.PartType.Ball flash.Size=Vector3.new(.4,.4,.4)
		flash.CFrame=CFrame.new(gd.muzzle.Position) flash.Anchored=true flash.CanCollide=false
		flash.Color=Color3.fromRGB(255,200,50) flash.Material=Enum.Material.Neon
		TW:Create(flash,TweenInfo.new(.08),{Size=Vector3.new(1,1,1),Transparency=1}):Play() DEB:AddItem(flash,.1)
		local snd=Instance.new("Sound",gd.torso) snd.SoundId="rbxassetid://168143115"
		snd.Volume=.3 snd.PlaybackSpeed=.9+math.random()*.3 snd:Play() DEB:AddItem(snd,1)
	end
	local dir=(tHRP.Position-gd.torso.Position)
	if dir.Magnitude>.01 then dir=dir.Unit else dir=Vector3.new(0,1,0) end
	masterFling(gd,targetChr,dir,100+math.random(0,50))
end

-- BUTTONS
btn("üìû CALL GUARDS",Color3.fromRGB(30,100,200),15,spawnAll)
btn("‚ùå DISMISS",Color3.fromRGB(150,30,30),16,clearAll)
btn("üîÑ REGROUP",Color3.fromRGB(30,120,55),17,function()
	local c=P.Character if not c then return end local h=c:FindFirstChild("HumanoidRootPart") if not h then return end
	forceHold=false patrolMode=false
	for i,gd in ipairs(guards) do if gd.model.Parent and gd.hum.Health>0 then
		gd.hum:MoveTo(h.Position+Vector3.new(math.cos((i/#guards)*math.pi*2)*4,0,math.sin((i/#guards)*math.pi*2)*4))
	end end notify("üîÑ Regrouping!",Color3.fromRGB(30,120,55))
end)
btn("üéØ ATTACK NEAREST",Color3.fromRGB(180,50,20),18,function()
	local c=P.Character if not c then return end local h=c:FindFirstChild("HumanoidRootPart") if not h then return end
	local best,bd=nil,math.huge
	for _,pl in ipairs(game.Players:GetPlayers()) do if pl~=P and pl.Character then
		local ph=pl.Character:FindFirstChild("HumanoidRootPart")
		if ph then local d=(ph.Position-h.Position).Magnitude if d<bd then best,bd=pl,d end end
	end end
	if best then commandTarget=best notify("üéØ "..best.Name,Color3.fromRGB(180,50,20))
	else notify("‚ùå No targets.",Color3.fromRGB(150,30,30)) end
end)
btn("üõ°Ô∏è SHIELD",Color3.fromRGB(25,55,150),19,function()
	forceShield=not forceShield
	if forceShield then formation="Surround"
		for k,v in pairs(fBs) do v.BackgroundColor3=k=="Surround" and Color3.fromRGB(50,120,255) or Color3.fromRGB(25,25,40) end
		-- Show shield parts
		for _,gd in ipairs(guards) do if gd.shield then gd.shield.Transparency=.5 end end
	else
		for _,gd in ipairs(guards) do if gd.shield then gd.shield.Transparency=1 end end
	end
	notify(forceShield and "üõ°Ô∏è ON!" or "üõ°Ô∏è OFF!",Color3.fromRGB(25,55,150))
end)
btn("üèÉ CHARGE!",Color3.fromRGB(180,90,10),20,function()
	forceCharge=true aggroMode="Berserker"
	for k,v in pairs(mBs) do v.BackgroundColor3=k=="Berserker" and mCs.Berserker or Color3.fromRGB(25,25,40) end
	notify("üèÉ BERSERKER!",Color3.fromRGB(180,20,20))
	task.delay(10,function() forceCharge=false end)
end)
btn("‚úã HOLD",Color3.fromRGB(70,70,90),21,function()
	forceHold=not forceHold patrolMode=false
	notify(forceHold and "‚úã Holding!" or "‚úã Moving.",Color3.fromRGB(70,70,90))
end)
btn("ü©π HEAL",Color3.fromRGB(25,150,55),22,function()
	for _,gd in ipairs(guards) do if gd.model.Parent and gd.hum.Health>0 then gd.hum.Health=gd.hum.MaxHealth
		local hf=Instance.new("Part",workspace) hf.Shape=Enum.PartType.Ball hf.Size=Vector3.new(2,2,2)
		hf.CFrame=CFrame.new(gd.torso.Position) hf.Anchored=true hf.CanCollide=false
		hf.Color=Color3.fromRGB(50,255,100) hf.Material=Enum.Material.Neon hf.Transparency=.3
		TW:Create(hf,TweenInfo.new(.5),{Size=Vector3.new(5,5,5),Transparency=1}):Play() DEB:AddItem(hf,.6)
	end end notify("ü©π Healed!",Color3.fromRGB(25,150,55))
end)
btn("ü™Ç RESCUE: ON",Color3.fromRGB(30,120,160),23,function()
	autoRescue=not autoRescue
	-- Find the button and update text
	for _,c in ipairs(scroll:GetChildren()) do
		if c:IsA("TextButton") and c.Text:find("RESCUE") then
			c.Text=autoRescue and "ü™Ç RESCUE: ON" or "ü™Ç RESCUE: OFF"
			c.BackgroundColor3=autoRescue and Color3.fromRGB(30,120,160) or Color3.fromRGB(80,40,40)
		end
	end
	notify(autoRescue and "ü™Ç Rescue ON!" or "ü™Ç Rescue OFF!",Color3.fromRGB(30,120,160))
end)
sep(24)

-- WAYPOINT & PATROL
btn("üìç SET WAYPOINT",Color3.fromRGB(40,160,90),25,function()
	local c=P.Character if not c then return end local h=c:FindFirstChild("HumanoidRootPart") if not h then return end
	local pos=h.Position
	local idx=#waypoints+1
	local marker=createWaypointMarker(pos,idx)
	table.insert(waypoints,{pos=pos,marker=marker})
	wpL.Text="üìç Waypoints: "..#waypoints
	notify("üìç Waypoint #"..idx.." set!",Color3.fromRGB(40,160,90))
end)
btn("üìç PATROL WAYPOINTS",Color3.fromRGB(40,140,120),26,function()
	if #waypoints<2 then notify("Need 2+ waypoints!",Color3.fromRGB(180,40,40)) return end
	patrolMode=not patrolMode forceHold=false
	notify(patrolMode and "üìç Patrol ON!" or "üìç Patrol OFF!",Color3.fromRGB(40,140,120))
end)
btn("üìç CLEAR WAYPOINTS",Color3.fromRGB(100,60,30),27,function()
	for _,w in ipairs(waypoints) do if w.marker and w.marker.Parent then w.marker:Destroy() end end
	waypoints={} patrolMode=false wpL.Text="üìç Waypoints: 0"
	notify("üìç Cleared!",Color3.fromRGB(100,60,30))
end)
sep(28)

-- SPY
btn("üïµÔ∏è SPY NEAREST",Color3.fromRGB(90,35,140),29,function()
	local c=P.Character if not c then return end local h=c:FindFirstChild("HumanoidRootPart") if not h then return end
	local best,bd=nil,math.huge
	for _,pl in ipairs(game.Players:GetPlayers()) do if pl~=P and pl.Character then
		local ph=pl.Character:FindFirstChild("HumanoidRootPart")
		if ph then local d=(ph.Position-h.Position).Magnitude if d<bd then best,bd=pl,d end end
	end end
	if best then
		for _,sd in ipairs(spies) do if sd.target==best then notify("Already spying.",Color3.fromRGB(90,35,140)) return end end
		table.insert(spies,createSpy(best)) spL.Text="üïµÔ∏è Spies: "..#spies
		notify("üïµÔ∏è "..best.Name,Color3.fromRGB(90,35,140))
	end
end)
btn("üïµÔ∏è SPY ALL",Color3.fromRGB(110,45,170),30,function()
	for _,sd in ipairs(spies) do sd.active=false for _,m in ipairs(sd.markers) do if m.Parent then m:Destroy() end end end
	spies={}
	for _,pl in ipairs(game.Players:GetPlayers()) do if pl~=P then table.insert(spies,createSpy(pl)) end end
	spL.Text="üïµÔ∏è Spies: "..#spies
	notify("üïµÔ∏è All!",Color3.fromRGB(110,45,170))
end)
btn("üïµÔ∏è STOP SPY",Color3.fromRGB(70,25,95),31,function()
	for _,sd in ipairs(spies) do sd.active=false for _,m in ipairs(sd.markers) do if m.Parent then m:Destroy() end end end
	spies={} spL.Text="üïµÔ∏è Spies: 0" notify("üïµÔ∏è Stopped.",Color3.fromRGB(70,25,95))
end)
sep(32)
lbl("G-Toggle H-Call J-Dismiss",33)
lbl("K-Regroup L-Attack N-Spy",34)

-- Toggle
local guiOpen=true
local tBtn=Instance.new("TextButton",sg) tBtn.Size=UDim2.new(0,32,0,32) tBtn.Position=UDim2.new(0,245,0.2,0)
tBtn.BackgroundColor3=Color3.fromRGB(15,25,55) tBtn.Text="üõ°Ô∏è" tBtn.TextSize=16
tBtn.Font=Enum.Font.GothamBold tBtn.TextColor3=Color3.new(1,1,1) tBtn.BorderSizePixel=0
Instance.new("UICorner",tBtn).CornerRadius=UDim.new(1,0)
Instance.new("UIStroke",tBtn).Color=Color3.fromRGB(50,120,255)
local function togGUI() guiOpen=not guiOpen
	TW:Create(main,TweenInfo.new(.2),{Position=guiOpen and UDim2.new(0,10,0.2,0) or UDim2.new(0,-240,0.2,0)}):Play()
	TW:Create(tBtn,TweenInfo.new(.2),{Position=guiOpen and UDim2.new(0,245,0.2,0) or UDim2.new(0,6,0.2,0)}):Play()
end
tBtn.MouseButton1Click:Connect(togGUI)

UIS.InputBegan:Connect(function(i,g) if g then return end
	if i.KeyCode==Enum.KeyCode.G then togGUI()
	elseif i.KeyCode==Enum.KeyCode.H then spawnAll()
	elseif i.KeyCode==Enum.KeyCode.J then clearAll()
	elseif i.KeyCode==Enum.KeyCode.K then
		local c=P.Character if not c then return end local h=c:FindFirstChild("HumanoidRootPart") if not h then return end
		for ii,gd in ipairs(guards) do if gd.model.Parent and gd.hum.Health>0 then
			gd.hum:MoveTo(h.Position+Vector3.new(math.cos((ii/#guards)*math.pi*2)*4,0,math.sin((ii/#guards)*math.pi*2)*4))
		end end
	elseif i.KeyCode==Enum.KeyCode.L then
		local c=P.Character if not c then return end local h=c:FindFirstChild("HumanoidRootPart") if not h then return end
		local best,bd=nil,math.huge
		for _,pl in ipairs(game.Players:GetPlayers()) do if pl~=P and pl.Character then
			local ph=pl.Character:FindFirstChild("HumanoidRootPart")
			if ph then local d=(ph.Position-h.Position).Magnitude if d<bd then best,bd=pl,d end end
		end end
		if best then commandTarget=best notify("üéØ "..best.Name,Color3.fromRGB(180,50,20)) end
	elseif i.KeyCode==Enum.KeyCode.N then
		local c=P.Character if not c then return end local h=c:FindFirstChild("HumanoidRootPart") if not h then return end
		local best,bd=nil,math.huge
		for _,pl in ipairs(game.Players:GetPlayers()) do if pl~=P and pl.Character then
			local ph=pl.Character:FindFirstChild("HumanoidRootPart")
			if ph then local d=(ph.Position-h.Position).Magnitude if d<bd then best,bd=pl,d end end
		end end
		if best then for _,sd in ipairs(spies) do if sd.target==best then return end end
			table.insert(spies,createSpy(best)) spL.Text="üïµÔ∏è Spies: "..#spies
		end
	end
end)

-- ============================================
-- MAIN AI LOOP
-- ============================================
local aiT,chatT=0,0

RS.Heartbeat:Connect(function(dt)
	for _,gd in ipairs(guards) do if gd.model.Parent and gd.hum.Health>0 then animGuard(gd) end end
	if not active or #guards==0 then return end
	local chr=P.Character if not chr then return end
	local hrp=chr:FindFirstChild("HumanoidRootPart") if not hrp then return end
	local myH=chr:FindFirstChildWhichIsA("Humanoid") if not myH then return end

	aiT+=dt if aiT<.2 then return end aiT=0
	flL.Text="üíÄ Flings: "..totalFlings

	-- Clean dead
	for i=#guards,1,-1 do local gd=guards[i]
		if not gd.model.Parent or gd.hum.Health<=0 then
			if gd.flingProxy and gd.flingProxy.Parent then gd.flingProxy:Destroy() end
			if gd.model.Parent then notify("üíÄ Guard #"..gd.index.."!",Color3.fromRGB(180,40,40)) gd.model:Destroy() end
			table.remove(guards,i)
		end
	end
	gL.Text="üë• Guards: "..#guards.."/"..guardCount
	if #guards==0 then active=false stL.Text="‚ö° All down!" return end

	-- IMPROVED FALL RESCUE - won't trigger from our own flings
	if autoRescue then
		local falling=false
		if myH:GetState()==Enum.HumanoidStateType.Freefall then
			-- Check if this was caused by our fling system (within 4 seconds)
			local selfCaused=(tick()-playerFlungTime)<4

			if not selfCaused then
				local ray=workspace:Raycast(hrp.Position,Vector3.new(0,-300,0))
				-- Only rescue if TRULY falling to death (very high up, no ground below, or falling for a while)
				if not ray then
					falling=true -- no ground at all
				elseif(hrp.Position.Y-ray.Position.Y)>80 then
					falling=true -- very high up
				end
				-- Also check velocity - only rescue if falling DOWN fast
				if hrp.Velocity.Y>-50 then falling=false end -- not falling fast enough
			end
		end

		if falling and not rescued and(tick()-rescueCooldown)>8 then
			rescued=true rescueCooldown=tick()
			stL.Text="‚ö° ü™Ç RESCUE!"
			hrp.Velocity=Vector3.new(hrp.Velocity.X,0,hrp.Velocity.Z)
			local bv=Instance.new("BodyVelocity",hrp) bv.MaxForce=Vector3.new(math.huge,math.huge,math.huge)
			bv.Velocity=Vector3.new(0,60,0) DEB:AddItem(bv,.5)
			local safe=Vector3.new(0,50,0)
			for _,d in ipairs({Vector3.new(0,50,0),Vector3.new(20,50,0),Vector3.new(-20,50,0),Vector3.new(0,50,20)}) do
				local r=workspace:Raycast(hrp.Position+Vector3.new(d.X,0,d.Z),Vector3.new(0,-500,0))
				if r and r.Instance.Anchored then safe=r.Position+Vector3.new(0,4,0) break end
			end
			task.delay(.5,function()
				if chr.Parent and hrp.Parent then hrp.CFrame=CFrame.new(safe) hrp.Velocity=Vector3.zero end
			end)
			say(guards[1],"rescue")
			notify("ü™Ç RESCUED!",Color3.fromRGB(30,150,80))
			task.delay(5,function() rescued=false end)
			return
		end
	end

	-- Threats
	local threats={}
	for _,pl in ipairs(game.Players:GetPlayers()) do
		if pl~=P and isChasing(pl,chr) then table.insert(threats,pl) end
	end
	if commandTarget and commandTarget.Character and commandTarget.Character:FindFirstChildWhichIsA("Humanoid") then
		if commandTarget.Character:FindFirstChildWhichIsA("Humanoid").Health>0 then
			local found=false for _,t in ipairs(threats) do if t==commandTarget then found=true break end end
			if not found then table.insert(threats,1,commandTarget) end
		else commandTarget=nil end
	end
	thL.Text="‚ö†Ô∏è Threats: "..#threats

	-- Chat
	chatT+=.2
	if chatT>20 and #guards>0 then chatT=0
		pcall(function()
			local ch=TS:FindFirstChild("TextChannels")
			if ch then local gen=ch:FindFirstChild("RBXGeneral") if gen then
				local others={} for _,pl in ipairs(game.Players:GetPlayers()) do if pl~=P then table.insert(others,pl.Name) end end
				if #others>0 then
					local tgt=others[math.random(#others)]
					local msgs={"Watching "..tgt..".","Eyes on "..tgt..".",tgt.." looks sus.","Monitoring "..tgt..".","Stay back "..tgt.."."}
					gen:SendAsync(msgs[math.random(#msgs)])
				end
			end end
		end)
	end

	-- Low HP
	if myH.Health<myH.MaxHealth*.3 then
		stL.Text="‚ö° üõ°Ô∏è SHIELD!"
		for i,gd in ipairs(guards) do if gd.model.Parent and gd.hum.Health>0 then
			say(gd,"rescue") gd.hum.WalkSpeed=30
			local a=(i/#guards)*math.pi*2
			gd.hum:MoveTo(hrp.Position+Vector3.new(math.cos(a)*2.5,0,math.sin(a)*2.5))
			if gd.shield then gd.shield.Transparency=.4 end
		end end return
	else
		-- Hide shields when not low HP and not forceShield
		if not forceShield then
			for _,gd in ipairs(guards) do if gd.shield then gd.shield.Transparency=1 end end
		end
	end

	-- COMBAT
	if #threats>0 then
		stL.Text="‚ö° ‚ö†Ô∏è "..#threats.." THREATS!"
		local resp=#guards
		if aggroMode=="Passive" then resp=math.min(2,#guards) elseif aggroMode=="Defensive" then resp=math.ceil(#guards*.6) end

		for i,gd in ipairs(guards) do
			if not gd.model.Parent or gd.hum.Health<=0 then continue end
			if i<=resp then
				local tI=((i-1)%#threats)+1 local tP=threats[tI]
				if tP.Character then
					local tHRP=tP.Character:FindFirstChild("HumanoidRootPart")
					if tHRP then
						gd.state="attacking" gd.target=tP
						gd.hum.WalkSpeed=aggroMode=="Berserker" and 35 or 28
						gd.hum:MoveTo(tHRP.Position)
						local dist=(gd.torso.Position-tHRP.Position).Magnitude

						if dist>8 and dist<55 then shootAt(gd,tP.Character) end

						if dist<8 and tick()-gd.lastAttack>.6 then
							gd.lastAttack=tick() gd.state="punching"
							local dir=(tHRP.Position-gd.torso.Position)
							if dir.Magnitude>.01 then dir=dir.Unit else dir=Vector3.new(0,1,0) end

							gd.combo+=1
							local act=math.random(1,10)
							if act<=3 then
								masterFling(gd,tP.Character,dir,130+math.random(0,60))
								say(gd,"fling")
							elseif act<=5 then
								local objs={}
								for _,p in ipairs(workspace:GetDescendants()) do
									if p:IsA("BasePart") and not p.Anchored and p.Size.Magnitude<18 and not p.Parent:FindFirstChildWhichIsA("Humanoid") and(p.Position-gd.torso.Position).Magnitude<30 then
										table.insert(objs,p) end
								end
								if #objs>0 then
									local obj=objs[math.random(#objs)]
									obj.Velocity=(tHRP.Position-obj.Position).Unit*250+Vector3.new(0,80,0)
								end
								masterFling(gd,tP.Character,dir,80)
							elseif act<=7 then
								masterFling(gd,tP.Character,Vector3.new(dir.X*.3,1,dir.Z*.3).Unit,160)
								say(gd,"fling")
							elseif act<=9 then
								-- Combo
								masterFling(gd,tP.Character,dir,70)
								task.delay(.25,function() if tP.Character then masterFling(gd,tP.Character,Vector3.new(0,1,0),130) say(gd,"fling") end end)
							else
								-- Mega fling (every 5 combos)
								if gd.combo%5==0 then
									masterFling(gd,tP.Character,Vector3.new(0,1,0),250)
									say(gd,"taunt")
									notify("üí• MEGA FLING!",Color3.fromRGB(255,100,30))
								else
									masterFling(gd,tP.Character,dir,100)
								end
							end
						end
					end
				end
			else
				gd.state="shielding" gd.hum.WalkSpeed=22
				local td=nil
				if threats[1] and threats[1].Character then
					local th=threats[1].Character:FindFirstChild("HumanoidRootPart")
					if th then td=th.Position-hrp.Position end
				end
				gd.hum:MoveTo(getFormPos(i,#guards,hrp.CFrame,td))
			end
		end
	else
		stL.Text=forceHold and "‚ö° Holding" or(forceShield and "‚ö° Shield" or(patrolMode and "‚ö° Patrolling" or "‚ö° Guarding"))
		commandTarget=nil

		for i,gd in ipairs(guards) do
			if not gd.model.Parent or gd.hum.Health<=0 then continue end
			gd.state="idle" gd.target=nil gd.hum.WalkSpeed=20 gd.combo=0

			if patrolMode and #waypoints>=2 then
				-- Patrol between waypoints
				local wp=waypoints[gd.patrolIdx]
				if wp then
					local dist=(gd.torso.Position-wp.pos).Magnitude
					if dist<4 then
						gd.patrolIdx=gd.patrolIdx%#waypoints+1
						say(gd,"patrol")
					end
					gd.hum:MoveTo(wp.pos)
				end
			elseif not forceHold then
				gd.hum:MoveTo(getFormPos(i,#guards,hrp.CFrame,nil))
			end

			if math.random(1,300)==1 then say(gd,"idle") end
		end
	end

	-- Auto heal
	for _,gd in ipairs(guards) do
		if gd.model.Parent and gd.hum.Health>0 and gd.hum.Health<gd.hum.MaxHealth and(gd.torso.Position-hrp.Position).Magnitude<15 then
			gd.hum.Health=math.min(gd.hum.MaxHealth,gd.hum.Health+2)
		end
	end

	-- Reinforce
	if #guards<guardCount and #guards>0 and math.random(1,80)==1 then
		local ng=deployGuard(guardCount,guardCount) if ng then table.insert(guards,ng) notify("üöÅ Reinforcement!",Color3.fromRGB(30,100,200)) end
	end

	-- Reset fling flag after timeout
	if tick()-playerFlungTime>5 then playerFlung=false end
end)

-- Respawn
P.CharacterAdded:Connect(function(nc) task.wait(1.5)
	if active and #guards>0 then
		local h=nc:WaitForChild("HumanoidRootPart",5) if h then
			for i,gd in ipairs(guards) do if gd.model.Parent and gd.hum.Health>0 then
				pcall(function() gd.model:SetPrimaryPartCFrame(CFrame.new(h.Position+Vector3.new(math.cos((i/#guards)*math.pi*2)*5,3,math.sin((i/#guards)*math.pi*2)*5))) end)
				-- Recreate fling proxy for new character
				if gd.flingProxy and gd.flingProxy.Parent then gd.flingProxy:Destroy() end
				gd.flingProxy=nil gd.flingWeld=nil
			end end
		end
	end
end)

-- Pulse
task.spawn(function() while task.wait(2) do
	TW:Create(ms,TweenInfo.new(2,Enum.EasingStyle.Sine),{Color=Color3.fromRGB(80,160,255)}):Play() task.wait(2)
	TW:Create(ms,TweenInfo.new(2,Enum.EasingStyle.Sine),{Color=Color3.fromRGB(30,60,180)}):Play()
end end)
